# Volatility
###### Volatility is an open-source memory forensics framework for incident response and malware analysis. It is written in Python and supports Microsoft Windows, Mac OS X, and Linux. Volatility is one of the best open source software programs for analyzing RAM in 32 bit/64 bit systems.


Analysis can generally be accomplished in six steps:
1. Identify Rogue Processes
2. Analyze Process DLLs and Handles
3. Review Network Artifacts
4. Look for Evidence of Code Injection
5. Check for Signs of a Rootkit
6. Extract Processes, Drivers, and Objects

Good references:

	- Download: https://www.volatilityfoundation.org/releases
	- Github: https://github.com/volatilityfoundation/volatility
	- CheatSheet: https://digital-forensics.sans.org/media/volatility-memory-forensics-cheat-sheet.pdf
	- Wiki: https://www.aldeid.com/wiki/Volatility
	- Official Guide Volatility for Windows: https://github.com/volatilityfoundation/volatility/wiki/Installation#dependencies
	- Alternative Guide Volatility for Windows: https://dfironthemountain.wordpress.com/2018/10/29/installing-volatility-on-windows/
	- Large guide use of Volatility: https://resources.infosecinstitute.com/memory-forensics-and-analysis-using-volatility/
	- Analysis of RAM using Volatility infected with Cridex malware: https://medium.com/@zemelusa/first-steps-to-volatile-memory-analysis-dcbd4d2d56a1
	- Analysis with Volatility in Spanish part 1: https://byte-mind.net/analisis-forense-con-volatility/
	- Analysis with Volatility in Spanish part 2: https://byte-mind.net/cazando-malware-con-volatility/

	

## Image identification


First we do **IMAGEINFO** to know which profile are we analyzing, this pluging will list a couple of suggested profiles, also we will see how many processors the target machine has. 
This plugin is the one that takes the longest time to run because it is trying to determine the profile of the machine. 

```
root@kali20203:/home/user/Desktop# volatility -f memdump.mem imageinfo
Volatility Foundation Volatility Framework 2.6
INFO    : volatility.debug    : Determining profile based on KDBG search...
          Suggested Profile(s) : Win7SP1x64, Win7SP0x64, Win2008R2SP0x64, Win2008R2SP1x64_24000, Win2008R2SP1x64_23418, Win2008R2SP1x64, Win7SP1x64_24000, Win7SP1x64_23418
                     AS Layer1 : WindowsAMD64PagedMemory (Kernel AS)
                     AS Layer2 : FileAddressSpace (/home/user/Desktop/memdump.mem)
                      PAE type : No PAE
                           DTB : 0x187000L
                          KDBG : 0xf80002bf5120L
          Number of Processors : 3
     Image Type (Service Pack) : 1
                KPCR for CPU 0 : 0xfffff80002bf7000L
                KPCR for CPU 1 : 0xfffff88002f00000L
                KPCR for CPU 2 : 0xfffff88002f7d000L
             KUSER_SHARED_DATA : 0xfffff78000000000L
           Image date and time : 2020-10-21 18:07:23 UTC+0000
     Image local date and time : 2020-10-21 20:07:23 +0200
```


The **KDBGSCAN** plugin shows the exact profile of the image analysed it will scan the signatures on the image headers and matches them with the profiles stored in the volatility database, thereby reducing the number of possible false positives.

```

root@kali20203:/home/user/Desktop# volatility -f memdump.mem --profile=Win7SP1x64 kdbgscan
Volatility Foundation Volatility Framework 2.6
**************************************************
Instantiating KDBG using: Kernel AS Win7SP1x64 (6.1.7601 64bit)
Offset (V)                    : 0xf80002bf5120
Offset (P)                    : 0x2bf5120
KDBG owner tag check          : True
Profile suggestion (KDBGHeader): Win7SP1x64
Version64                     : 0xf80002bf50e8 (Major: 15, Minor: 7601)
Service Pack (CmNtCSDVersion) : 1
Build string (NtBuildLab)     : 7601.24214.amd64fre.win7sp1_ldr_
PsActiveProcessHead           : 0xfffff80002c2e940 (39 processes)
PsLoadedModuleList            : 0xfffff80002c4cc90 (156 modules)
KernelBase                    : 0xfffff80002a12000 (Matches MZ: True)
Major (OptionalHeader)        : 6
Minor (OptionalHeader)        : 1
KPCR                          : 0xfffff80002bf7000 (CPU 0)
KPCR                          : 0xfffff88002f00000 (CPU 1)
KPCR                          : 0xfffff88002f7d000 (CPU 2)

**************************************************
Instantiating KDBG using: Kernel AS Win7SP1x64 (6.1.7601 64bit)
Offset (V)                    : 0xf80002bf5120
Offset (P)                    : 0x2bf5120
KDBG owner tag check          : True
Profile suggestion (KDBGHeader): Win7SP0x64
Version64                     : 0xf80002bf50e8 (Major: 15, Minor: 7601)
Service Pack (CmNtCSDVersion) : 1
Build string (NtBuildLab)     : 7601.24214.amd64fre.win7sp1_ldr_
PsActiveProcessHead           : 0xfffff80002c2e940 (39 processes)
PsLoadedModuleList            : 0xfffff80002c4cc90 (156 modules)
KernelBase                    : 0xfffff80002a12000 (Matches MZ: True)
Major (OptionalHeader)        : 6
Minor (OptionalHeader)        : 1
KPCR                          : 0xfffff80002bf7000 (CPU 0)
KPCR                          : 0xfffff88002f00000 (CPU 1)
KPCR                          : 0xfffff88002f7d000 (CPU 2)

**************************************************

```

With **KPCRSCAN** you are going to be able to see details for each processor since each processor has its own KPCR.  Kernel Processor Control Region is a structure which contains information about the processor  including IDT and GDT addresses; current, inactive and subsequent threads; number of CPUs, provider and speed; and CR3 value.
This plugin also takes time to execute depending of the size of the memory dump


- https://en.wikipedia.org/wiki/Processor_Control_Region

```

root@kali20203:/home/user/Desktop# volatility -f memdump.mem --profile=Win7SP1x64 kpcrscan
Volatility Foundation Volatility Framework 2.6


```


## Process identification


With **PSLIST** we can see the processes that are running at the time of the memory dump. PID is the process identity, PPID is the parent process identity, OFFSET is the hexadecimal scrolling direction.  It will go through the linked list pointing to PsActiveProcessHead

```
root@kali20203:/home/user/Desktop# volatility -f memdump.mem --profile=Win7SP1x64 pslist
Volatility Foundation Volatility Framework 2.6
Offset(V)          Name                    PID   PPID   Thds     Hnds   Sess  Wow64 Start                          Exit                          
------------------ -------------------- ------ ------ ------ -------- ------ ------ ------------------------------ ------------------------------
0xfffffa8020903040 System                    4      0     96      499 ------      0 2020-10-21 17:40:20 UTC+0000                                 
0xfffffa8021c43b00 smss.exe                280      4      2       31 ------      0 2020-10-21 17:40:20 UTC+0000                                 
0xfffffa8021930060 csrss.exe               368    352      9      401      0      0 2020-10-21 17:41:00 UTC+0000                                 
0xfffffa8022b6f420 csrss.exe               424    416     12      250      1      0 2020-10-21 17:41:09 UTC+0000                                 
0xfffffa8022b70890 wininit.exe             432    352      3       82      0      0 2020-10-21 17:41:09 UTC+0000                                 
0xfffffa8022bba060 services.exe            500    432      8      220      0      0 2020-10-21 17:41:13 UTC+0000                                 
0xfffffa8022bdf060 winlogon.exe            508    416      3      116      1      0 2020-10-21 17:41:13 UTC+0000                                 
0xfffffa8022be3b00 lsass.exe               520    432      7      583      0      0 2020-10-21 17:41:14 UTC+0000                                 
0xfffffa8022bf49a0 lsm.exe                 532    432      9      144      0      0 2020-10-21 17:41:14 UTC+0000                                 
0xfffffa8022c926a0 svchost.exe             644    500      9      362      0      0 2020-10-21 17:41:25 UTC+0000                                 
0xfffffa8022c87450 svchost.exe             724    500      7      265      0      0 2020-10-21 17:41:27 UTC+0000                                 
0xfffffa8022cc7b00 svchost.exe             804    500     20      468      0      0 2020-10-21 17:41:30 UTC+0000                                 
0xfffffa8022cf5260 svchost.exe             852    500     17      440      0      0 2020-10-21 17:41:33 UTC+0000                                 
0xfffffa8022d15060 svchost.exe             880    500     14      556      0      0 2020-10-21 17:41:33 UTC+0000                                 
0xfffffa8022d1d060 svchost.exe             904    500     33      916      0      0 2020-10-21 17:41:33 UTC+0000                                 
0xfffffa8022db8b00 svchost.exe             740    500     14      475      0      0 2020-10-21 17:41:52 UTC+0000                                 
0xfffffa8022eb3b00 spoolsv.exe            1240    500     13      286      0      0 2020-10-21 17:42:04 UTC+0000                                 
0xfffffa8022ebc8f0 svchost.exe            1268    500     19      319      0      0 2020-10-21 17:42:04 UTC+0000                                 
0xfffffa8021ff1950 svchost.exe            1372    500     10      154      0      0 2020-10-21 17:42:11 UTC+0000                                 
0xfffffa8022cf6890 VGAuthService.         1504    500      3       89      0      0 2020-10-21 17:42:31 UTC+0000                                 
0xfffffa8020a6bb00 taskhost.exe           1660    500      9      245      1      0 2020-10-21 17:42:48 UTC+0000                                 
0xfffffa8022fbcb00 dwm.exe                1668    852      5      154      1      0 2020-10-21 17:42:50 UTC+0000                                 
0xfffffa8022fc0b00 explorer.exe           1676   1652     25     1024      1      0 2020-10-21 17:42:50 UTC+0000                                 
0xfffffa80230098f0 vmtoolsd.exe           1784    500     11      295      0      0 2020-10-21 17:42:54 UTC+0000                                 
0xfffffa802310d8e0 svchost.exe            1156    500      6       96      0      0 2020-10-21 17:43:23 UTC+0000                                 
0xfffffa8022006b00 dllhost.exe             376    500     13      196      0      0 2020-10-21 17:43:29 UTC+0000                                 
0xfffffa802311fb00 WmiPrvSE.exe           2068    644     10      219      0      0 2020-10-21 17:43:31 UTC+0000                                 
0xfffffa8023121b00 msdtc.exe              2076    500     12      148      0      0 2020-10-21 17:43:31 UTC+0000                                 
0xfffffa8020b272d0 vm3dservice.ex         2176   1676      2       50      1      0 2020-10-21 17:43:36 UTC+0000                                 
0xfffffa8020b37b00 vmtoolsd.exe           2188   1676      8      185      1      0 2020-10-21 17:43:36 UTC+0000                                 
0xfffffa8020afab00 SearchIndexer.         2508    500     12      574      0      0 2020-10-21 17:43:45 UTC+0000                                 
0xfffffa8020d5bb00 sppsvc.exe             2996    500      4      151      0      0 2020-10-21 17:45:31 UTC+0000                                 
0xfffffa80220efb00 svchost.exe             668    500     13      348      0      0 2020-10-21 17:45:32 UTC+0000                                 
0xfffffa8020dab680 FTK Imager.exe         2912   1676     13      333      1      1 2020-10-21 17:46:28 UTC+0000                                 
0xfffffa80212483c0 malvado.exe            2972   1676      3       99      1      1 2020-10-21 18:05:07 UTC+0000                                 
0xfffffa8021075200 cmd.exe                2428   1676      1       22      1      0 2020-10-21 18:05:49 UTC+0000                                 
0xfffffa802124eb00 conhost.exe            2672    424      2       53      1      0 2020-10-21 18:05:49 UTC+0000                                 
0xfffffa802124a060 taskmgr.exe            1436   1676      6      123      1      0 2020-10-21 18:10:24 UTC+0000                                 
0xfffffa8020c36790 svchost.exe             836    500      0 --------      0      0 2020-10-21 18:12:53 UTC+0000   2020-10-21 18:15:03 UTC+0000  
```

**PSTREE** also shows the processes that were running on the machine at the time of the break-in, but in a hierarchical tree format. 

```

root@kali20203:/home/user/Desktop# volatility -f memdump.mem --profile=Win7SP1x64 pstree
Volatility Foundation Volatility Framework 2.6
Name                                                  Pid   PPid   Thds   Hnds Time
-------------------------------------------------- ------ ------ ------ ------ ----
 0xfffffa8022fc0b00:explorer.exe                     1676   1652     25   1024 2020-10-21 17:42:50 UTC+0000
. 0xfffffa8020b272d0:vm3dservice.ex                  2176   1676      2     50 2020-10-21 17:43:36 UTC+0000
. 0xfffffa80212483c0:malvado.exe                     2972   1676      3     99 2020-10-21 18:05:07 UTC+0000
. 0xfffffa8020dab680:FTK Imager.exe                  2912   1676     13    333 2020-10-21 17:46:28 UTC+0000
. 0xfffffa8020b37b00:vmtoolsd.exe                    2188   1676      8    185 2020-10-21 17:43:36 UTC+0000
. 0xfffffa8021075200:cmd.exe                         2428   1676      1     22 2020-10-21 18:05:49 UTC+0000
. 0xfffffa802124a060:taskmgr.exe                     1436   1676      6    123 2020-10-21 18:10:24 UTC+0000
 0xfffffa8020903040:System                              4      0     96    499 2020-10-21 17:40:20 UTC+0000
. 0xfffffa8021c43b00:smss.exe                         280      4      2     31 2020-10-21 17:40:20 UTC+0000
 0xfffffa8021930060:csrss.exe                         368    352      9    401 2020-10-21 17:41:00 UTC+0000
 0xfffffa8022b70890:wininit.exe                       432    352      3     82 2020-10-21 17:41:09 UTC+0000
. 0xfffffa8022be3b00:lsass.exe                        520    432      7    583 2020-10-21 17:41:14 UTC+0000
. 0xfffffa8022bf49a0:lsm.exe                          532    432      9    144 2020-10-21 17:41:14 UTC+0000
. 0xfffffa8022bba060:services.exe                     500    432      8    220 2020-10-21 17:41:13 UTC+0000
.. 0xfffffa8022c926a0:svchost.exe                     644    500      9    362 2020-10-21 17:41:25 UTC+0000
... 0xfffffa802311fb00:WmiPrvSE.exe                  2068    644     10    219 2020-10-21 17:43:31 UTC+0000
.. 0xfffffa8023121b00:msdtc.exe                      2076    500     12    148 2020-10-21 17:43:31 UTC+0000
.. 0xfffffa802310d8e0:svchost.exe                    1156    500      6     96 2020-10-21 17:43:23 UTC+0000
.. 0xfffffa8022cc7b00:svchost.exe                     804    500     20    468 2020-10-21 17:41:30 UTC+0000
.. 0xfffffa80220efb00:svchost.exe                     668    500     13    348 2020-10-21 17:45:32 UTC+0000
.. 0xfffffa8022d1d060:svchost.exe                     904    500     33    916 2020-10-21 17:41:33 UTC+0000
.. 0xfffffa8020d5bb00:sppsvc.exe                     2996    500      4    151 2020-10-21 17:45:31 UTC+0000
.. 0xfffffa8020c36790:svchost.exe                     836    500      0 ------ 2020-10-21 18:12:53 UTC+0000
.. 0xfffffa8020afab00:SearchIndexer.                 2508    500     12    574 2020-10-21 17:43:45 UTC+0000
.. 0xfffffa8022006b00:dllhost.exe                     376    500     13    196 2020-10-21 17:43:29 UTC+0000
.. 0xfffffa8022c87450:svchost.exe                     724    500      7    265 2020-10-21 17:41:27 UTC+0000
.. 0xfffffa8022eb3b00:spoolsv.exe                    1240    500     13    286 2020-10-21 17:42:04 UTC+0000
.. 0xfffffa8021ff1950:svchost.exe                    1372    500     10    154 2020-10-21 17:42:11 UTC+0000
.. 0xfffffa8022cf6890:VGAuthService.                 1504    500      3     89 2020-10-21 17:42:31 UTC+0000
.. 0xfffffa8022db8b00:svchost.exe                     740    500     14    475 2020-10-21 17:41:52 UTC+0000
.. 0xfffffa8022d15060:svchost.exe                     880    500     14    556 2020-10-21 17:41:33 UTC+0000
.. 0xfffffa8022ebc8f0:svchost.exe                    1268    500     19    319 2020-10-21 17:42:04 UTC+0000
.. 0xfffffa80230098f0:vmtoolsd.exe                   1784    500     11    295 2020-10-21 17:42:54 UTC+0000
.. 0xfffffa8022cf5260:svchost.exe                     852    500     17    440 2020-10-21 17:41:33 UTC+0000
... 0xfffffa8022fbcb00:dwm.exe                       1668    852      5    154 2020-10-21 17:42:50 UTC+0000
.. 0xfffffa8020a6bb00:taskhost.exe                   1660    500      9    245 2020-10-21 17:42:48 UTC+0000
 0xfffffa8022b6f420:csrss.exe                         424    416     12    250 2020-10-21 17:41:09 UTC+0000
. 0xfffffa802124eb00:conhost.exe                     2672    424      2     53 2020-10-21 18:05:49 UTC+0000
 0xfffffa8022bdf060:winlogon.exe                      508    416      3    116 2020-10-21 17:41:13 UTC+0000

```

With **PSXVIEW**  all the processes that are tried to be hidden will be listed, notice in which columns the value "False" appears the most relevant are pslist and psscan


```

root@kali20203:/home/user/Desktop# volatility -f memdump.mem --profile=Win7SP1x64 psxview
Volatility Foundation Volatility Framework 2.6
Offset(P)          Name                    PID pslist psscan thrdproc pspcid csrss session deskthrd ExitTime
------------------ -------------------- ------ ------ ------ -------- ------ ----- ------- -------- --------
0x00000000a895bb00 sppsvc.exe             2996 True   False  False    True   True  True    False    
0x00000000a74efb00 svchost.exe             668 True   False  False    True   True  True    False    
0x00000000a8a6bb00 taskhost.exe           1660 True   False  False    True   True  True    False    
0x00000000a650d8e0 svchost.exe            1156 True   False  False    True   True  True    False    
0x00000000a68f6890 VGAuthService.         1504 True   False  False    True   True  True    True     
0x00000000a824eb00 conhost.exe            2672 True   False  False    True   True  True    False    
0x00000000a824a060 taskmgr.exe            1436 True   False  False    True   True  True    False    
0x00000000a6bf49a0 lsm.exe                 532 True   False  False    True   True  True    False    
0x00000000a66bc8f0 svchost.exe            1268 True   False  False    True   True  True    False    
0x00000000a66b3b00 spoolsv.exe            1240 True   False  False    True   True  True    True     
0x00000000a77f1950 svchost.exe            1372 True   False  False    True   True  True    True     
0x00000000a8b37b00 vmtoolsd.exe           2188 True   False  False    True   True  True    True     
0x00000000a67c0b00 explorer.exe           1676 True   False  False    True   True  True    True     
0x00000000a67bcb00 dwm.exe                1668 True   False  False    True   True  True    False    
0x00000000a89ab680 FTK Imager.exe         2912 True   False  False    True   True  True    False    
0x00000000a82483c0 malvado.exe            2972 True   False  False    True   True  True    False    
0x00000000a691d060 svchost.exe             904 True   False  False    True   True  True    True     
0x00000000a8475200 cmd.exe                2428 True   False  False    True   True  True    False    
0x00000000a8afab00 SearchIndexer.         2508 True   False  False    True   True  True    True     

```


With **SVCSCAN** to be able to see the services that were active on the machine when the dumper was made. It gives information such as the OFFSET, when this process will start, the current status of the service, name, description and how that service is running. 

```
root@kali20203:/home/user/Desktop# volatility -f memdump.mem --profile=Win7SP1x64 svcscan | more
Volatility Foundation Volatility Framework 2.6
Offset: 0xce3690
Order: 71
Start: SERVICE_AUTO_START
Process ID: 644
Service Name: DcomLaunch
Display Name: DCOM Server Process Launcher
Service Type: SERVICE_WIN32_SHARE_PROCESS
Service State: SERVICE_RUNNING
Binary Path: C:\Windows\system32\svchost.exe -k DcomLaunch

Offset: 0xce35a0
Order: 70
Start: SERVICE_DEMAND_START
Process ID: -
Service Name: dc21x4vm
Display Name: dc21x4vm
Service Type: SERVICE_KERNEL_DRIVER
Service State: SERVICE_STOPPED
Binary Path: -

Offset: 0xce34b0
Order: 69
Start: SERVICE_AUTO_START
Process ID: 852
Service Name: CscService
Display Name: Offline Files
Service Type: SERVICE_WIN32_SHARE_PROCESS
Service State: SERVICE_RUNNING
Binary Path: C:\Windows\System32\svchost.exe -k LocalSystemNetworkRestricted
--More--

```

We may use **grep** to look for something more specific that might give us information that a service has been hijacked. 

```

root@kali20203:/home/user/Desktop# volatility -f memdump.mem --profile=Win7SP1x64 svcscan | grep -i "Binary Path:" | grep -v "Binary Path: -"
Volatility Foundation Volatility Framework 2.6
Binary Path: C:\Windows\system32\svchost.exe -k DcomLaunch
Binary Path: C:\Windows\System32\svchost.exe -k LocalSystemNetworkRestricted
Binary Path: \Driver\CSC
Binary Path: C:\Windows\system32\svchost.exe -k NetworkService
Binary Path: C:\Windows\system32\dllhost.exe /Processid:{02D4B3F1-FD88-11D1-960D-00805FC79235}
Binary Path: \Driver\Compbatt
Binary Path: \Driver\CNG
Binary Path: \Driver\CLFS
Binary Path: \Driver\cdrom
Binary Path: C:\Windows\system32\svchost.exe -k bthsvcs
Binary Path: \FileSystem\bowser
Binary Path: \Driver\blbdrive
Binary Path: C:\Windows\system32\svchost.exe -k LocalServiceNoNetwork

```

With **DLLLIST** we can see that all the dll files of all the processes executed at that time by the User and the Operate System 


```
root@kali20203:/home/user/Desktop# volatility --profile=Win7SP1x64 -f memdump.mem dlllist | more
Volatility Foundation Volatility Framework 2.6
************************************************************************
System pid:      4
Unable to read PEB for task.
************************************************************************
smss.exe pid:    280
Command line : \SystemRoot\System32\smss.exe


Base                             Size          LoadCount LoadTime                       Path
------------------ ------------------ ------------------ ------------------------------ ----
0x0000000047a50000            0x20000             0xffff 1970-01-01 00:00:00 UTC+0000   \SystemRoot\System32\smss.exe
0x0000000077430000           0x19f000             0xffff 1970-01-01 00:00:00 UTC+0000   C:\Windows\SYSTEM32\ntdll.dll
************************************************************************
csrss.exe pid:    368
Command line : %SystemRoot%\system32\csrss.exe ObjectDirectory=\Windows SharedSection=1024,20480,768 Windows=On SubSystemType=Windows ServerDll=basesrv,1 Serve
rDll=winsrv:UserServerDllInitialization,3 ServerDll=winsrv:ConServerDllInitialization,2 ServerDll=sxssrv,4 ProfileControl=Off MaxRequestThreads=16
Service Pack 1

```

Since **DLLLIST** will display a large list you can also specify the PID you are looking for

```

root@kali20203:/home/user/Desktop# volatility --profile=Win7SP1x64 -f memdump.mem dlllist -p 2972
Volatility Foundation Volatility Framework 2.6
************************************************************************
malvado.exe pid:   2972
Command line : "C:\Users\user\Desktop\malvado.exe" 


Base                             Size          LoadCount LoadTime                       Path
------------------ ------------------ ------------------ ------------------------------ ----
0x0000000000400000            0x16000             0xffff 1970-01-01 00:00:00 UTC+0000   C:\Users\user\Desktop\malvado.exe
0x0000000077430000           0x19f000             0xffff 1970-01-01 00:00:00 UTC+0000   C:\Windows\SYSTEM32\ntdll.dll
0x0000000074750000            0x3f000                0x3 2020-10-21 18:05:07 UTC+0000   C:\Windows\SYSTEM32\wow64.dll
0x00000000746f0000            0x5c000                0x1 2020-10-21 18:05:07 UTC+0000   C:\Windows\SYSTEM32\wow64win.dll
0x0000000074bb0000             0x8000                0x1 2020-10-21 18:05:07 UTC+0000   C:\Windows\SYSTEM32\wow64cpu.dll
0x0000000000400000            0x16000             0xffff 1970-01-01 00:00:00 UTC+0000   C:\Users\user\Desktop\malvado.exe
0x00000000775f0000           0x180000             0xffff 1970-01-01 00:00:00 UTC+0000   C:\Windows\SysWOW64\ntdll.dll
0x0000000075620000           0x110000             0xffff 2020-10-21 18:05:07 UTC+0000   C:\Windows\syswow64\kernel32.dll
0x0000000076190000            0x47000             0xffff 2020-10-21 18:05:07 UTC+0000   C:\Windows\syswow64\KERNELBASE.dll
0x0000000076510000            0xac000             0xffff 2020-10-21 18:05:07 UTC+0000   C:\Windows\syswow64\MSVCRT.dll
0x0000000075570000            0xa1000             0xffff 2020-10-21 18:05:07 UTC+0000   C:\Windows\syswow64\ADVAPI32.dll
0x00000000753f0000            0x19000             0xffff 2020-10-21 18:05:07 UTC+0000   C:\Windows\SysWOW64\sechost.dll
0x0000000074dc0000            0xf0000             0xffff 2020-10-21 18:05:07 UTC+0000   C:\Windows\syswow64\RPCRT4.dll
0x0000000074d60000            0x60000             0xffff 2020-10-21 18:05:07 UTC+0000   C:\Windows\syswow64\SspiCli.dll
0x0000000074d50000             0xc000             0xffff 2020-10-21 18:05:07 UTC+0000   C:\Windows\syswow64\CRYPTBASE.dll
0x0000000074140000             0x7000             0xffff 2020-10-21 18:05:07 UTC+0000   C:\Windows\system32\WSOCK32.dll
0x00000000764d0000            0x35000             0xffff 2020-10-21 18:05:07 UTC+0000   C:\Windows\syswow64\WS2_32.dll
0x0000000075730000             0x6000             0xffff 2020-10-21 18:05:07 UTC+0000   C:\Windows\syswow64\NSI.dll
0x000000006fe40000            0x3c000                0x2 2020-10-21 18:05:08 UTC+0000   C:\Windows\system32\mswsock.dll
0x0000000076260000           0x100000               0xb1 2020-10-21 18:05:08 UTC+0000   C:\Windows\syswow64\user32.dll

```

With **DLLDUMP** we can extract all the files and save them in a folder

```


root@kali20203:/home/user/Desktop# volatility --profile=Win7SP1x64 -f memdump.mem dlldump -D /home/user/Desktop/dll_dump/
Volatility Foundation Volatility Framework 2.6
Process(V)         Name                 Module Base        Module Name          Result
------------------ -------------------- ------------------ -------------------- ------
0xfffffa8021c43b00 smss.exe             0x0000000047a50000 smss.exe             OK: module.280.a7843b00.47a50000.dll
0xfffffa8021c43b00 smss.exe             0x0000000077430000 ntdll.dll            OK: module.280.a7843b00.77430000.dll
0xfffffa8021930060 csrss.exe            0x0000000049dd0000 csrss.exe            OK: module.368.a7d30060.49dd0000.dll
0xfffffa8021930060 csrss.exe            0x0000000077430000 ntdll.dll            OK: module.368.a7d30060.77430000.dll
0xfffffa8021930060 csrss.exe            0x000007fefcf40000 sxssrv.DLL           OK: module.368.a7d30060.7fefcf40000.dll
0xfffffa8021930060 csrss.exe            0x0000000077330000 USER32.dll           OK: module.368.a7d30060.77330000.dll
0xfffffa8021930060 csrss.exe            0x000007fefe5f0000 LPK.dll              OK: module.368.a7d30060.7fefe5f0000.dll
0xfffffa8021930060 csrss.exe            0x000007feff070000 msvcrt.dll           OK: module.368.a7d30060.7feff070000.dll
0xfffffa8021930060 csrss.exe            0x000007fefce80000 sxs.dll              OK: module.368.a7d30060.7fefce80000.dll
0xfffffa8021930060 csrss.exe            0x000007fefcf90000 basesrv.DLL          OK: module.368.a7d30060.7fefcf90000.dll
0xfffffa8021930060 csrss.exe            0x000007fefee20000 RPCRT4.dll           OK: module.368.a7d30060.7fefee20000.dll
0xfffffa8021930060 csrss.exe            0x000007fefce70000 CRYPTBASE.dll        OK: module.368.a7d30060.7fefce70000.dll
0xfffffa8021930060 csrss.exe            0x000007fefcfb0000 CSRSRV.dll           OK: module.368.a7d30060.7fefcfb0000.dll
0xfffffa8021930060 csrss.exe            0x000007feff1c0000 USP10.dll            OK: module.368.a7d30060.7feff1c0000.dll
0xfffffa8021930060 csrss.exe            0x000007fefd120000 KERNELBASE.dll       OK: module.368.a7d30060.7fefd120000.dll
0xfffffa8021930060 csrss.exe            0x000007fefd390000 GDI32.dll            OK: module.368.a7d30060.7fefd390000.dll
0xfffffa8021930060 csrss.exe            0x0000000077210000 kernel32.dll         OK: module.368.a7d30060.77210000.dll
0xfffffa8021930060 csrss.exe            0x000007fefcf50000 winsrv.DLL           OK: module.368.a7d30060.7fefcf50000.dll
0xfffffa8022b6f420 csrss.exe            0x0000000049dd0000 csrss.exe            OK: module.424.a6b6f420.49dd0000.dll
0xfffffa8022b6f420 csrss.exe            0x0000000077430000 ntdll.dll            OK: module.424.a6b6f420.77430000.dll
0xfffffa8022b6f420 csrss.exe            0x000007fefcf40000 sxssrv.DLL           OK: module.424.a6b6f420.7fefcf40000.dll
0xfffffa8022b6f420 csrss.exe            0x0000000077330000 USER32.dll           OK: module.424.a6b6f420.77330000.dll
0xfffffa8022b6f420 csrss.exe            0x000007fefe5f0000 LPK.dll              OK: module.424.a6b6f420.7fefe5f0000.dll
0xfffffa8022b6f420 csrss.exe            0x000007feff070000 msvcrt.dll           OK: module.424.a6b6f420.7feff070000.dll

```

## Review Network Artifacts



To be able to review Network Artifacts we are going to use the plug-in **NETSCAN** which is going to scan a Windows Vista (or later Windows OS) image for connections and sockets. We can also use **SOCKETS** that print a list of open sockets and **CONNSCAN** that list TCP connections


```

root@kali20203:/home/user/Desktop# volatility -f memdump.mem --profile=Win7SP1x64 netscan
Volatility Foundation Volatility Framework 2.6
Offset(P)          Proto    Local Address                  Foreign Address      State            Pid      Owner          Created
0xa6989630         UDPv4    0.0.0.0:5355                   *:*                                   740      svchost.exe    2020-10-21 18:12:01 UTC+0000
0xa6989630         UDPv6    :::5355                        *:*                                   740      svchost.exe    2020-10-21 18:12:01 UTC+0000
0xa69bd370         UDPv4    192.168.52.139:138             *:*                                   4        System         2020-10-21 17:41:55 UTC+0000
0xa6b55010         UDPv4    0.0.0.0:0                      *:*                                   740      svchost.exe    2020-10-21 17:41:55 UTC+0000
0xa6b55010         UDPv6    :::0                           *:*                                   740      svchost.exe    2020-10-21 17:41:55 UTC+0000
0xa6b55350         UDPv4    192.168.52.139:137             *:*                                   4        System         2020-10-21 17:41:55 UTC+0000
0xa64a6ee0         TCPv4    0.0.0.0:49156                  0.0.0.0:0            LISTENING        500      services.exe   
0xa6654e00         TCPv4    0.0.0.0:49156                  0.0.0.0:0            LISTENING        500      services.exe   
0xa6654e00         TCPv6    :::49156                       :::0                 LISTENING        500      services.exe   
0xa6693d90         TCPv4    0.0.0.0:49155                  0.0.0.0:0            LISTENING        904      svchost.exe    
0xa6693d90         TCPv6    :::49155                       :::0                 LISTENING        904      svchost.exe    
0xa67dbdf0         TCPv4    0.0.0.0:445                    0.0.0.0:0            LISTENING        4        System         
0xa67dbdf0         TCPv6    :::445                         :::0                 LISTENING        4        System         
0xa68acee0         TCPv4    0.0.0.0:135                    0.0.0.0:0            LISTENING        724      svchost.exe    
0xa68acee0         TCPv6    :::135                         :::0                 LISTENING        724      svchost.exe    
0xa68b33b0         TCPv4    0.0.0.0:49152                  0.0.0.0:0            LISTENING        432      wininit.exe    
0xa68bbba0         TCPv4    0.0.0.0:135                    0.0.0.0:0            LISTENING        724      svchost.exe    
0xa68f3ee0         TCPv4    0.0.0.0:49153                  0.0.0.0:0            LISTENING        804      svchost.exe    
0xa68f3ee0         TCPv6    :::49153                       :::0                 LISTENING        804      svchost.exe    
0xa68f42b0         TCPv4    0.0.0.0:49153                  0.0.0.0:0            LISTENING        804      svchost.exe    
0xa6900180         TCPv4    0.0.0.0:49154                  0.0.0.0:0            LISTENING        520      lsass.exe      
0xa6900180         TCPv6    :::49154                       :::0                 LISTENING        520      lsass.exe      
0xa6941640         TCPv4    0.0.0.0:49154                  0.0.0.0:0            LISTENING        520      lsass.exe      
0xa69c4010         TCPv4    0.0.0.0:49155                  0.0.0.0:0            LISTENING        904      svchost.exe    
0xa6b3b600         TCPv4    192.168.52.139:139             0.0.0.0:0            LISTENING        4        System         
0xa6bab970         TCPv4    0.0.0.0:49152                  0.0.0.0:0            LISTENING        432      wininit.exe    
0xa6bab970         TCPv6    :::49152                       :::0                 LISTENING        432      wininit.exe    
0xa6b76730         TCPv4    192.168.52.139:49161           192.168.52.134:51632 ESTABLISHED      -1                      
0xa8458370         UDPv4    0.0.0.0:5355                   *:*                                   740      svchost.exe    2020-10-21 18:12:01 UTC+0000
0xa849f8f0         UDPv6    fe80::fce6:adb:371d:37a8:546   *:*                                   804      svchost.exe    2020-10-21 18:10:26 UTC+0000
0xa88751d0         UDPv6    fe80::fce6:adb:371d:37a8:546   *:*                                   804      svchost.exe    2020-10-21 18:17:35 UTC+0000
0xa8d4cc10         UDPv4    0.0.0.0:0                      *:*                                   904      svchost.exe    2020-10-21 18:18:47 UTC+0000
0xa8d4cc10         UDPv6    :::0                           *:*                                   904      svchost.exe    2020-10-21 18:18:47 UTC+0000

```

## Process memory

With **MEMMAP** will displays exactly which pages reside in memory, given a specific DTB process (or DTB kernel if you use this add-on in the idle or system process). This info comes from the get_available_addresses method of the underlying address space, it shows the virtual address of the page, the corresponding physical movement and the size of the page.

```

root@kali20203:/home/user/Desktop# volatility -f memdump.mem --profile=Win7SP1x64 memmap | more
Volatility Foundation Volatility Framework 2.6
System pid:      4
Virtual            Physical                         Size     DumpFileOffset
------------------ ------------------ ------------------ ------------------
0x0000000000010000 0x0000000054e3a000             0x1000                0x0
0x0000000000011000 0x0000000054e3b000             0x1000             0x1000
0x0000000000012000 0x0000000054e3c000             0x1000             0x2000
0x0000000000013000 0x0000000054e3d000             0x1000             0x3000
0x0000000000014000 0x0000000054e3e000             0x1000             0x4000
0x0000000000015000 0x0000000054e3f000             0x1000             0x5000
0x0000000000016000 0x0000000054f40000             0x1000             0x6000
0x0000000000017000 0x0000000054f41000             0x1000             0x7000
0x0000000000018000 0x0000000054f42000             0x1000             0x8000
0x0000000000019000 0x0000000054f43000             0x1000             0x9000
0x000000000001a000 0x0000000054f44000             0x1000             0xa000
0x000000000001b000 0x0000000054f45000             0x1000             0xb000
0x000000000001c000 0x0000000054f46000             0x1000             0xc000
0x000000000001d000 0x0000000054f47000             0x1000             0xd000
0x000000000001e000 0x0000000054f48000             0x1000             0xe000
0x000000000001f000 0x0000000054f49000             0x1000             0xf000
0x0000000000020000 0x0000000054e4a000             0x1000            0x10000
0x0000000000021000 0x0000000054e4b000             0x1000            0x11000
0x0000000000022000 0x0000000054f4c000             0x1000            0x12000
0x0000000000023000 0x0000000054f4d000             0x1000            0x13000
0x0000000000024000 0x0000000054f4e000             0x1000            0x14000
0x0000000000025000 0x0000000054f4f000             0x1000            0x15000

```

We can use **MEMDUMP** to extract all the pages resident in the memory of a process in an individual file. We can specify a process using his specific PID with the argument -p. To dump into a directory use -D argument


```

root@kali20203:/home/user/Desktop# volatility -f memdump.mem --profile=Win7SP1x64 memdump  -D /home/user/Desktop/memdump/
Volatility Foundation Volatility Framework 2.6
************************************************************************
Writing System [     4] to 4.dmp
************************************************************************
Writing smss.exe [   280] to 280.dmp
************************************************************************
Writing csrss.exe [   368] to 368.dmp
************************************************************************
Writing csrss.exe [   424] to 424.dmp
*******************************************************

```

The **PROCDUMP** plugin is used to extract executable used by a process. We can specify a process using his specific PID with the argument -p. To dump into a directory use -D argument

```

root@kali20203:/home/user/Desktop# volatility -f memdump.mem --profile=Win7SP1x64 procdump -p 2972 -D /home/user/Desktop/procdump/
Volatility Foundation Volatility Framework 2.6
Process(V)         ImageBase          Name                 Result
------------------ ------------------ -------------------- ------
0xfffffa80212483c0 0x0000000000400000 malvado.exe          OK: executable.2972.exe

```


## Command Lines & Consoles

We have a collection of plugins related to the execution of commands through a console. 
With **CMDSCAN** we are going to be able to search in the memory of the processes  csrss.exe in XP, 2003, Vista and 2008 and conhost.exe in Windows 7 and later, it will scan for COMMAND_HISTORY buffers. 


```

root@kali20203:/home/user/Desktop# volatility -f memdump.mem --profile=Win7SP1x64 cmdscan
Volatility Foundation Volatility Framework 2.6
**************************************************
CommandProcess: conhost.exe Pid: 2672
CommandHistory: 0x45cca0 Application: cmd.exe Flags: Allocated, Reset
CommandCount: 1 LastAdded: 0 LastDisplayed: 0
FirstCommand: 0 CommandCountMax: 50
ProcessHandle: 0x64
Cmd #0 @ 0x45b680: ipconfig
Cmd #15 @ 0x400158: E
Cmd #16 @ 0x45be10: E


```

With **CONSOLES** will find the various commands typed in locally or remotely via backdoors that will scan for _CONSOLE_INFORMATION buffers. 

```

root@kali20203:/home/user/Desktop# volatility -f memdump.mem --profile=Win7SP1x64 consoles
Volatility Foundation Volatility Framework 2.6
**************************************************
ConsoleProcess: conhost.exe Pid: 2672
Console: 0xffe46200 CommandHistorySize: 50
HistoryBufferCount: 2 HistoryBufferMax: 4
OriginalTitle: %SystemRoot%\system32\cmd.exe
Title: C:\Windows\system32\cmd.exe
AttachedProcess: cmd.exe Pid: 2428 Handle: 0x64
----
CommandHistory: 0x45cfb0 Application: ipconfig.exe Flags: 
CommandCount: 0 LastAdded: -1 LastDisplayed: -1
FirstCommand: 0 CommandCountMax: 50
ProcessHandle: 0x0
----
CommandHistory: 0x45cca0 Application: cmd.exe Flags: Allocated, Reset
CommandCount: 1 LastAdded: 0 LastDisplayed: 0
FirstCommand: 0 CommandCountMax: 50
ProcessHandle: 0x64
Cmd #0 at 0x45b680: ipconfig
----
Screen 0x43f1f0 X:80 Y:300
Dump:
Microsoft Windows [Version 6.1.7601]                                            
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.                 
                                                                                
C:\Users\user>ipconfig                                                          
                                                                                
Windows IP Configuration                                                        
                                                                                
                                                                                
Ethernet adapter Bluetooth Network Connection:                                  
                                                                                
   Media State . . . . . . . . . . . : Media disconnected                       
   Connection-specific DNS Suffix  . :                                          
                                                                                
Ethernet adapter Local Area Connection:                                         
                                                                                
   Connection-specific DNS Suffix  . : localdomain                              
   Link-local IPv6 Address . . . . . : fe80::fce6:adb:371d:37a8%11              
   IPv4 Address. . . . . . . . . . . : 192.168.52.139                           
   Subnet Mask . . . . . . . . . . . : 255.255.255.0                            
   Default Gateway . . . . . . . . . : 192.168.52.2                             
                                                                                
Tunnel adapter isatap.localdomain:                                              
                                                                                
   Media State . . . . . . . . . . . : Media disconnected                       
   Connection-specific DNS Suffix  . : localdomain                              
                                                                                
Tunnel adapter isatap.{E159CFDE-5BBB-471A-ABC7-1DB8BD04B5F0}:                   
                                                                                
   Media State . . . . . . . . . . . : Media disconnected                       
   Connection-specific DNS Suffix  . :                                          
                                                    
```

## Registry Analysis Plugins


We use **HIVELIST** to view the Hive registries, these are a group of registries that are loaded into memory when the OS starts or a user logs in. This is important because by having the SAM and SYSTEM files identified we can perform a dump and get the users and hashes of the users that were logged in on that machine:

- https://docs.microsoft.com/es-es/windows/win32/sysinfo/registry-hives?redirectedfrom=MSDN

```

root@kali20203:/home/user/Desktop# volatility -f memdump.mem --profile=Win7SP1x64 hivelist
Volatility Foundation Volatility Framework 2.6
Virtual            Physical           Name
------------------ ------------------ ----
0xfffff8a00441d010 0x000000005239a010 \SystemRoot\System32\Config\SECURITY
0xfffff8a00442d010 0x00000000524ab010 \SystemRoot\System32\Config\DEFAULT
0xfffff8a004430010 0x00000000526ae010 \SystemRoot\System32\Config\SAM
0xfffff8a00445e010 0x00000000425b8010 \??\C:\Windows\ServiceProfiles\LocalService\NTUSER.DAT
0xfffff8a00000f010 0x0000000055084010 [no name]
0xfffff8a000024010 0x000000005508f010 \REGISTRY\MACHINE\SYSTEM
0xfffff8a000058010 0x0000000054fc3010 \REGISTRY\MACHINE\HARDWARE
0xfffff8a00060c010 0x0000000052974010 \Device\HarddiskVolume1\Boot\BCD
0xfffff8a00061f010 0x0000000052439010 \SystemRoot\System32\Config\SOFTWARE
0xfffff8a001080010 0x0000000041e08010 \??\C:\Windows\ServiceProfiles\NetworkService\NTUSER.DAT
0xfffff8a001666010 0x0000000035b06010 \??\C:\Users\user\ntuser.dat
0xfffff8a001675010 0x000000004139a010 \??\C:\Users\user\AppData\Local\Microsoft\Windows\UsrClass.dat

```

With **HASHDUMP**, take note of the virtual values, we will now proceed to dump SAM with the argument -s and SYSTEM with -y. As a result we will be given the username and NTLM hash of that account

```

root@kali20203:/home/user/Desktop# volatility hashdump --profile=Win7SP1x64 -f memdump.mem -s 0xfffff8a00445e010 -y 0xfffff8a00441d010 
Volatility Foundation Volatility Framework 2.6
Administrador:500:e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c:::
usuariobasico:1125:5c56109436004859ebd85531b8d5539f:1bfd3d3e4d9b85290d000fe25714b487:::

```

Also with **HASHDUMP** you don't need to point out the OFFSETS of the SAM and SYSTEM to dump the NTLM hashes

```

root@kali20203:/home/user/Desktop# volatility --profile=Win7SP1x64 -f memdump.mem hashdump
Volatility Foundation Volatility Framework 2.6
Administrador:500:e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c:::
usuariobasico:1125:5c56109436004859ebd85531b8d5539f:1bfd3d3e4d9b85290d000fe25714b487:::

```


## Look for Evidence of Code Injection



With **MALFIND** find injected code and dump sections. It  helps in searching for codes/DLLs hidden or injected into the user's memory, depending on characteristics such as VAD tag and page permissions

```

root@kali20203:/home/user/Desktop# volatility -f memdump.mem --profile=Win7SP1x64 malfind -p 2972 
Volatility Foundation Volatility Framework 2.6
Process: malvado.exe Pid: 2972 Address: 0x20000
Vad Tag: VadS Protection: PAGE_EXECUTE_READWRITE
Flags: CommitCharge: 1, MemCommit: 1, PrivateMemory: 1, Protection: 6

0x00020000  eb 27 5b 53 5f b0 da fc ae 75 fd 57 59 53 5e 8a   .'[S_....u.WYS^.
0x00020010  06 30 07 48 ff c7 48 ff c6 66 81 3f ff 85 74 07   .0.H..H..f.?..t.
0x00020020  80 3e da 75 ea eb e6 ff e1 e8 d4 ff ff ff 02 07   .>.u............
0x00020030  05 06 da eb 27 5b 53 5f b0 09 fc ae 75 fd 57 59   ....'[S_....u.WY

0x00020000 eb27             JMP 0x20029
0x00020002 5b               POP EBX
0x00020003 53               PUSH EBX
0x00020004 5f               POP EDI
0x00020005 b0da             MOV AL, 0xda
0x00020007 fc               CLD
0x00020008 ae               SCASB
0x00020009 75fd             JNZ 0x20008
0x0002000b 57               PUSH EDI
0x0002000c 59               POP ECX
0x0002000d 53               PUSH EBX
0x0002000e 5e               POP ESI
0x0002000f 8a06             MOV AL, [ESI]
0x00020011 3007             XOR [EDI], AL
0x00020013 48               DEC EAX
0x00020014 ffc7             INC EDI
0x00020016 48               DEC EAX
0x00020017 ffc6             INC ESI
0x00020019 66813fff85       CMP WORD [EDI], 0x85ff
0x0002001e 7407             JZ 0x20027
0x00020020 803eda           CMP BYTE [ESI], 0xda
0x00020023 75ea             JNZ 0x2000f
0x00020025 ebe6             JMP 0x2000d
0x00020027 ffe1             JMP ECX
0x00020029 e8d4ffffff       CALL 0x20002
0x0002002e 0207             ADD AL, [EDI]
0x00020030 0506daeb27       ADD EAX, 0x27ebda06
0x00020035 5b               POP EBX
0x00020036 53               PUSH EBX
0x00020037 5f               POP EDI
0x00020038 b009             MOV AL, 0x9
0x0002003a fc               CLD
0x0002003b ae               SCASB
0x0002003c 75fd             JNZ 0x2003b
0x0002003e 57               PUSH EDI
0x0002003f 59               POP ECX

```

With the plugin **YARASCAN** it can help in searching, through regular expressions, for any byte sequence, ASCII strings or Unicode strings in user mode or in Kernel memory. For example I am searching for the byte pattern "{68 00 74 00 74 00 70 00}" which means "h.t.t.p."


```

root@kali20203:/home/user/Desktop# volatility -f memdump.mem --profile=Win7SP1x64 yarascan --yara-rules="{68 00 74 00 74 00 70 00}" -K | more
Volatility Foundation Volatility Framework 2.6
Rule: r1
Owner: tcpip.sys
0xf88001747660  68 00 74 00 74 00 70 00 00 00 00 00 00 00 00 00   h.t.t.p.........
0xf88001747670  08 00 0a 00 00 00 00 00 60 76 74 01 80 f8 ff ff   ........`vt.....
0xf88001747680  68 00 74 00 74 00 70 00 73 00 00 00 00 00 00 00   h.t.t.p.s.......
0xf88001747690  0a 00 0c 00 00 00 00 00 80 76 74 01 80 f8 ff ff   .........vt.....
0xf880017476a0  30 00 31 00 32 00 33 00 34 00 35 00 36 00 37 00   0.1.2.3.4.5.6.7.
0xf880017476b0  38 00 39 00 41 00 42 00 43 00 44 00 45 00 46 00   8.9.A.B.C.D.E.F.
0xf880017476c0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0xf880017476d0  00 08 00 00 08 08 00 08 08 08 08 0c 08 0c 0c 00   ................
0xf880017476e0  13 13 13 13 13 13 13 13 13 13 08 08 00 08 00 00   ................
0xf880017476f0  08 03 03 03 03 03 03 01 01 01 01 01 01 01 01 01   ................
0xf88001747700  01 01 01 01 01 01 01 01 01 01 01 00 00 00 00 08   ................
0xf88001747710  00 03 03 03 03 03 03 01 01 01 01 01 01 01 01 01   ................
0xf88001747720  01 01 01 01 01 01 01 01 01 01 01 00 00 00 08 00   ................
0xf88001747730  00 00 04 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0xf88001747740  24 b9 00 aa 6e f2 fe a3 d8 6c 9b cb 01 29 58 32   $...n....l...)X2
0xf88001747750  80 00 00 00 c0 00 00 00 e0 00 00 00 f0 00 00 00   ................


```

With **LDRMODULES** we are going to be able to detect unlinked DLLs. For each memory-mapped PE file, the ldrmodules command prints True or False if the PE exists in the PEB lists, it is possible that malware hides DLLs by simply modifying the path they show.
 
```

root@kali20203:/home/user/Desktop# volatility -f memdump.mem --profile=Win7SP1x64 -p 2972 ldrmodules | more
Volatility Foundation Volatility Framework 2.6
Pid      Process              Base               InLoad InInit InMem MappedPath
-------- -------------------- ------------------ ------ ------ ----- ----------
    2972 malvado.exe          0x0000000074bb0000 True   True   True  \Windows\System32\wow64cpu.dll
    2972 malvado.exe          0x000000006fdc0000 True   True   True  \Windows\SysWOW64\rsaenh.dll
    2972 malvado.exe          0x0000000076130000 True   True   True  \Windows\SysWOW64\userenv.dll
    2972 malvado.exe          0x0000000075740000 True   True   True  \Windows\SysWOW64\ole32.dll
    2972 malvado.exe          0x000000006fe40000 True   True   True  \Windows\SysWOW64\mswsock.dll
    2972 malvado.exe          0x0000000076360000 True   True   True  \Windows\SysWOW64\lpk.dll
    2972 malvado.exe          0x0000000075570000 True   True   True  \Windows\SysWOW64\advapi32.dll
    2972 malvado.exe          0x0000000076190000 True   True   True  \Windows\SysWOW64\KernelBase.dll
    2972 malvado.exe          0x0000000074ba0000 True   True   True  \Windows\SysWOW64\version.dll
    2972 malvado.exe          0x0000000075db0000 True   True   True  \Windows\SysWOW64\imm32.dll
    2972 malvado.exe          0x00000000775f0000 True   True   True  \Windows\SysWOW64\ntdll.dll
    2972 malvado.exe          0x00000000759f0000 True   True   True  \Windows\SysWOW64\api-ms-win-downlevel-version-l1-1-0.dll
    2972 malvado.exe          0x0000000000400000 True   False  True  \Users\user\Desktop\malvado.exe
    2972 malvado.exe          0x0000000075a10000 True   True   True  \Windows\SysWOW64\usp10.dll
    2972 malvado.exe          0x000000006f1e0000 True   True   True  \Windows\SysWOW64\dhcpcsvc.dll
    2972 malvado.exe          0x0000000075e30000 True   True   True  \Windows\SysWOW64\oleaut32.dll
    2972 malvado.exe          0x0000000075a00000 True   True   True  \Windows\SysWOW64\api-ms-win-downlevel-shlwapi-l1-1-0.dll
    2972 malvado.exe          0x0000000074270000 True   True   True  \Windows\SysWOW64\srvcli.dll
    2972 malvado.exe          0x0000000075410000 True   True   True  \Windows\SysWOW64\msctf.dll
    2972 malvado.exe          0x0000000074290000 True   True   True  \Windows\SysWOW64\netutils.dll
    2972 malvado.exe          0x0000000074eb0000 True   True   True  \Windows\SysWOW64\crypt32.dll
    2972 malvado.exe          0x00000000763a0000 True   True   True  \Windows\SysWOW64\psapi.dll
    2972 malvado.exe          0x0000000075ed0000 True   True   True  \Windows\SysWOW64\msasn1.dll
    2972 malvado.exe          0x0000000075620000 True   True   True  \Windows\SysWOW64\kernel32.dll
    2972 malvado.exe          0x0000000074ce0000 True   True   True  \Windows\SysWOW64\dhcpcsvc6.dll
    2972 malvado.exe          0x00000000746f0000 True   True   True  \Windows\System32\wow64win.dll
    2972 malvado.exe          0x0000000075e20000 True   True   True  \Windows\SysWOW64\api-ms-win-downlevel-normaliz-l1-1-0.dll
    2972 malvado.exe          0x0000000075ef0000 True   True   True  \Windows\SysWOW64\iertutil.dll
    2972 malvado.exe          0x0000000075730000 True   True   True  \Windows\SysWOW64\nsi.dll
    2972 malvado.exe          0x0000000074140000 True   True   True  \Windows\SysWOW64\wsock32.dll


```


With **IMPSCAN** we are going to be able to check the functions does the API call. Which identifies the API calls without parsing the IAT of a PE, and could work even if the malware completely deletes the PE header.

```

root@kali20203:/home/user/Desktop# volatility -f memdump.mem --profile=Win7SP1x64 -p 2972 impscan | more
Volatility Foundation Volatility Framework 2.6
IAT                Call               Module               Function
------------------ ------------------ -------------------- --------
0x000000000040c000 0x000000007558405e ADVAPI32.dll         FreeSid
0x000000000040c004 0x0000000075584016 ADVAPI32.dll         AllocateAndInitializeSid
0x000000000040c00c 0x00000000756b4f99 kernel32.dll         PeekNamedPipe
0x000000000040c010 0x0000000075633fd5 kernel32.dll         ReadFile
0x000000000040c014 0x0000000075631282 kernel32.dll         WriteFile
0x000000000040c018 0x00000000756348c7 kernel32.dll         LoadLibraryA
0x000000000040c01c 0x0000000075631222 kernel32.dll         GetProcAddress
0x000000000040c020 0x0000000075632518 kernel32.dll         GetVersionExA
0x000000000040c024 0x000000007564177d kernel32.dll         GetExitCodeProcess
0x000000000040c028 0x000000007564d84a kernel32.dll         TerminateProcess
0x000000000040c02c 0x00000000776122b0 kernel32.dll         LeaveCriticalSection
0x000000000040c030 0x0000000075631695 kernel32.dll         SetEvent
0x000000000040c034 0x000000007563111e kernel32.dll         ReleaseMutex
0x000000000040c038 0x00000000776122f0 kernel32.dll         EnterCriticalSection
0x000000000040c03c 0x0000000077623dcd kernel32.dll         DeleteCriticalSection
0x000000000040c040 0x0000000077624330 ntdll.dll            RtlInitializeCriticalSection
0x000000000040c044 0x0000000075634b5b kernel32.dll         CreateMutexA
0x000000000040c048 0x0000000075632530 kernel32.dll         GetFileType
0x000000000040c04c 0x00000000756311a9 kernel32.dll         SetLastError
0x000000000040c050 0x00000000756350bb kernel32.dll         FreeEnvironmentStringsW
0x000000000040c054 0x00000000756350d3 kernel32.dll         GetEnvironmentStringsW
0x000000000040c058 0x0000000075635f38 kernel32.dll         GlobalFree
0x000000000040c05c 0x0000000075635113 kernel32.dll         GetCommandLineW
0x000000000040c060 0x000000007563489d kernel32.dll         TlsAlloc
0x000000000040c064 0x0000000075632586 kernel32.dll         TlsFree
0x000000000040c068 0x0000000075631856 kernel32.dll         DuplicateHandle
0x000000000040c06c 0x00000000756317d9 kernel32.dll         GetCurrentProcess
0x000000000040c070 0x000000007564198c kernel32.dll         SetHandleInformation
0x000000000040c074 0x00000000756313e0 kernel32.dll         CloseHandle
0x000000000040c078 0x0000000075632508 kernel32.dll         GetSystemTimeAsFileTime
0x000000000040c07c 0x0000000075635e0c kernel32.dll         FileTimeToSystemTime
0x000000000040c080 0x0000000075635b5a kernel32.dll         GetTimeZoneInformation
0x000000000040c084 0x000000007563e2ce kernel32.dll         FileTimeToLocalFileTime
0x000000000040c088 0x00000000756359f6 kernel32.dll         SystemTimeToFileTime
0x000000000040c08c 0x000000007564fec2 kernel32.dll         SystemTimeToTzSpecificLocalTime
0x000000000040c090 0x00000000756310ff kernel32.dll         Sleep
0x000000000040c094 0x0000000075656115 kernel32.dll         FormatMessageA
0x000000000040c098 0x00000000756311c0 kernel32.dll         GetLastError
0x000000000040c09c 0x0000000075631136 kernel32.dll         WaitForSingleObject
0x000000000040c0a0 0x00000000756327dc kernel32.dll         CreateEventA
0x000000000040c0a4 0x00000000756b4cc7 kernel32.dll         SetStdHandle
0x000000000040c0a8 0x00000000756317a1 kernel32.dll         SetFilePointer
0x000000000040c0ac 0x0000000075635da6 kernel32.dll         CreateFileA
0x000000000040c0b0 0x0000000075634064 kernel32.dll         CreateFileW
0x000000000040c0b4 0x000000007564ccc9 kernel32.dll         GetOverlappedResult
0x000000000040c0b8 0x000000007563277f kernel32.dll         DeviceIoControl
0x000000000040c0bc 0x0000000075635d8e kernel32.dll         GetFileInformationByHandle
0x000000000040c0c0 0x0000000075632f3c kernel32.dll         LocalFree

```



## External Plugins

In order to use external plugins you only need to download the code from github, and point to it with the "plugins=" argument plus call the plugin by its name

With **AUTORUNS** will find persistence points (also called "Auto-Start Extensibility Points", or ASEPs) is a recurring task of any investigation potentially involving malware.

- https://github.com/tomchop/volatility-autoruns

```

root@kali20203:/home/user/Desktop# git clone https://github.com/tomchop/volatility-autoruns.git
Cloning into 'volatility-autoruns'...
remote: Enumerating objects: 169, done.
remote: Total 169 (delta 0), reused 0 (delta 0), pack-reused 169
Receiving objects: 100% (169/169), 91.18 KiB | 707.00 KiB/s, done.
Resolving deltas: 100% (92/92), done.

root@kali20203:/home/user/Desktop# volatility --plugins="/home/user/Desktop/volatility-autoruns/" -f memdump.mem --profile=Win7SP1x64 autoruns
Volatility Foundation Volatility Framework 2.6


Autoruns==========================================

Hive: \SystemRoot\System32\Config\SOFTWARE 
    Microsoft\Windows\CurrentVersion\Run (Last modified: 2020-10-03 20:12:28 UTC+0000)
        "C:\Windows\system32\vm3dservice.exe" -u : VMware VM3DService Process (PIDs: 2176)

Hive: \SystemRoot\System32\Config\SOFTWARE 
    Microsoft\Windows\CurrentVersion\Run (Last modified: 2020-10-03 20:12:28 UTC+0000)
        "C:\Program Files\VMware\VMware Tools\vmtoolsd.exe" -n vmusr : VMware User Process (PIDs: 2188)

Hive: \??\C:\Windows\ServiceProfiles\NetworkService\NTUSER.DAT 
    Software\Microsoft\Windows\CurrentVersion\Run (Last modified: 2009-07-14 04:45:47 UTC+0000)
        %ProgramFiles%\Windows Sidebar\Sidebar.exe /autoRun : Sidebar (PIDs: )

Hive: \??\C:\Windows\ServiceProfiles\LocalService\NTUSER.DAT 
    Software\Microsoft\Windows\CurrentVersion\Run (Last modified: 2009-07-14 04:45:48 UTC+0000)
        %ProgramFiles%\Windows Sidebar\Sidebar.exe /autoRun : Sidebar (PIDs: )

Hive: \??\C:\Windows\ServiceProfiles\NetworkService\NTUSER.DAT 
    Software\Microsoft\Windows\CurrentVersion\RunOnce (Last modified: 2011-12-20 12:57:38 UTC+0000)
        C:\Windows\System32\mctadmin.exe : mctadmin (PIDs: )

Hive: \??\C:\Windows\ServiceProfiles\LocalService\NTUSER.DAT 
    Software\Microsoft\Windows\CurrentVersion\RunOnce (Last modified: 2011-12-20 12:57:28 UTC+0000)
        C:\Windows\System32\mctadmin.exe : mctadmin (PIDs: )



Winlogon (Shell)==================================

Shell: explorer.exe
    Default value: Explorer.exe
    PIDs: 1676
    Last write time: 2020-10-21 17:41:37 UTC+0000



Winlogon (Userinit)===============================

Userinit: C:\Windows\system32\userinit.exe,
    Default value: userinit.exe
    PIDs: 
    Last write time: 2020-10-21 17:41:37 UTC+0000



Services==========================================

Service: clr_optimization_v4.0.30319_32 - Microsoft .NET Framework NGEN v4.0.30319_X86 (Win32_Own_Process - Auto Start)
    Image path: C:\Windows\Microsoft.NET\Framework\v4.0.30319\mscorsvw.exe (Last modified: 2018-08-15 11:22:17 UTC+0000)
    PIDs: 

Service: clr_optimization_v4.0.30319_64 - Microsoft .NET Framework NGEN v4.0.30319_X64 (Win32_Own_Process - Auto Start)
    Image path: C:\Windows\Microsoft.NET\Framework64\v4.0.30319\mscorsvw.exe (Last modified: 2018-08-15 11:22:17 UTC+0000)
    PIDs: 

Service: VGAuthService - VMware Alias Manager and Ticket Service (Win32_Own_Process - Auto Start)
    Image path: "C:\Program Files\VMware\VMware Tools\VMware VGAuth\VGAuthService.exe" (Last modified: 2020-10-03 11:12:12 UTC+0000)
    PIDs: 1504

Service: VMTools - VMware Tools (Win32_Own_Process - Auto Start)
    Image path: "C:\Program Files\VMware\VMware Tools\vmtoolsd.exe" (Last modified: 2020-10-03 20:27:09 UTC+0000)
    PIDs: 1784, 2188



Active Setup======================================

Command line: %SystemRoot%\system32\unregmp2.exe /ShowWMP
Last-written: 2018-08-15 10:13:34 UTC+0000 (PIDs: )

Command line: %SystemRoot%\system32\regsvr32.exe /s /n /i:/UserInstall %SystemRoot%\system32\themeui.dll
Last-written: 2009-07-14 04:49:00 UTC+0000 (PIDs: )

Command line: "%ProgramFiles%\Windows Mail\WinMail.exe" OCInstallUserConfigOE
Last-written: 2010-11-21 03:33:56 UTC+0000 (PIDs: )

Command line: C:\Windows\System32\ie4uinit.exe -EnableTLS
Last-written: 2018-08-15 10:13:34 UTC+0000 (PIDs: )

Command line: %SystemRoot%\system32\unregmp2.exe /FirstLogon /Shortcuts /RegBrowsers /ResetMUI
Last-written: 2018-08-15 10:13:34 UTC+0000 (PIDs: )

Command line: C:\Windows\System32\ie4uinit.exe -DisableSSL3
Last-written: 2018-08-15 09:01:55 UTC+0000 (PIDs: )

Command line: regsvr32.exe /s /n /i:U shell32.dll
Last-written: 2018-08-15 10:13:34 UTC+0000 (PIDs: )

Command line: C:\Windows\System32\ie4uinit.exe -UserConfig
Last-written: 2018-08-15 09:04:45 UTC+0000 (PIDs: )

Command line: C:\Windows\system32\Rundll32.exe C:\Windows\system32\mscories.dll,Install
Last-written: 2011-12-20 12:57:19 UTC+0000 (PIDs: )

```
